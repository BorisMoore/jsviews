/*
 * jQuery Views Plugin v1.0pre
 * Interactive data-driven views, based on integration between jQuery Templates and jQuery Data Link.
 * Requires jquery.render.js (optimized version of jQuery Templates, for rendering to string).
 * See JsRender at http://github.com/BorisMoore/jsrender
 * and JsViews at http://github.com/BorisMoore/jsviews
 */
(function(a,b){var h,d,w,p={value:"val",html:"html",text:"text"},q="_jsvData",m={change:function(k){var n,m,c,j,g,i,h,l,o,u,e=this.target,f=k.target,s=a(f),t=this.links,q=this.options.beforeChange,v=t.length;while(v--&&!m){i=t[v];if(!i.from||i.from&&a(f).is(i.from)){c=i.fromAttr;if(!c){c=d.merge[f.nodeName.toLowerCase()];c=c?c.from.fromAttr:"text"}n=p[c];g=a.isFunction(c)?c(f):n?s[n]():s.attr(c);if((!q||!(m=q(k)===false))&&g!==b){j=i.to;if(!j){var r=f.getAttribute(d.linkToAttr);if(r){u=/([\$\w\.]+)?(?:\((.*?)\))?(?:\[([\w\.]*)\])(?:\:\s*(\w+)\((.*?)\))?\s*$/;r.replace(u,function(m,b,k,g,d,c){if(b)e=window[b];else{o=a.view(f);e=o&&o.data||e}j=g;h=d||i.convert;l=c})}}if(h)if(e[h])g=e[h].call(e,g,f,j,e,l);else if(h=window[h])g=h(g,f,j,e,l);e&&a.observable(e).setProperty(j,g);this.options.afterChange&&this.options.afterChange(k)}m&&k.stopImmediatePropagation()}}},propertyChange:function(n,g){var k,u,f=this,m=f.target,i=a(m),r=n.target,v=f.inner||f.from||f.getFrom,e=f.toAttr,c=g?g.value:t(r,v),o=g&&g.path,q=f.options,s=q.beforeChange,w=a.view(m);if((!s||!(g&&(u=s.call(this,n,g)===false)))&&c!==b&&(!o||o===v)&&(!w||w.onDataChanged(g)!==false)){var j,h=f.convert;if(h)if(a.isFunction(h))c=h.call(f,c,r,o,m);else if(h=l(r,f.convert)||l(window,f.convert))c=h[0][h[1]].call(h[0],c);if(!e){e=d.merge[m.nodeName.toLowerCase()];e=e?e.to.toAttr:"text"}if(css=e.indexOf("css-")===0&&e.substr(4))(j=i.css(css)!==c)&&i.css(css,c);else{k=p[e];if(k)(j=i[k]()!==c)&&i[k](c);else(j=i.attr(e)!==c)&&i.attr(e,c)}g&&j&&q.afterChange&&q.afterChange.call(this,n,g)}u&&n.stopImmediatePropagation()},arrayChange:function(e,a){var g,h=this.target,c=this.options.beforeChange,f=a?a.change:d.linkToAttr;if((!c||!(g=c(e,a)===false))&&f!==b){h.onDataChanged(a);this.options.afterChange&&this.options.afterChange(e,a)}}};function i(h,g,k,b,i,l,d){var f,e,c=this;a.extend(c,{views:[],nodes:h?[]:[document.body],tmpl:k||b&&b.tmpl,path:g,parent:b,prevNode:h});if(b){c.options=l||b.options;f=b.views;i.push(c);d=d||b.data;if(a.isArray(b.data)){c.index=e=g;f.splice(e,0,c);viewCount=f.length;d=d[e];while(e++<viewCount-1)a.observable(f[e]).setProperty("index",e)}else{if(g)d=new Function("$","$view","$data","with($data){ return "+g+";}")(a,b,d);c.index=f.length;f.push(c)}}c.data=d;j(c)}function f(g,p,k,r,w,m,v,s){function t(a,f){var i,d,b=m||p.data;a=a.split(/\:\s*/);if(a[1]){i=a[0];a[0]=a[1]}a=a[0];if(f){d=a;a=f}var c={target:g,toAttr:i,convert:d};a=a.split(/\[|\]/);if(a[1]){b=a[0]==="$view"?h:window[a[0]]||b;a[0]=a[1]}c[this]=a[0];e(b,g,c,false,k)}var l,x,n,z,y,j,u,h=p,q=w;k=k||p.options;s=s||0;g=v||g;if(!v&&g.nodeType===1){q++===0&&h.nodes.push(g);o(g.getAttribute(d.getFromAttr),"getFrom",t);o(g.getAttribute(d.linkFromAttr),"from",t);g=g.firstChild}else g=g.nextSibling;while(g&&g!==r){if(g.nodeType===1)f(g,h,k,r,q,m);else if(g.nodeType===8&&(l=/^(\/?)(?:(item)|(?:tmpl(?:\((.*)\))?(?:\s+([^\s]+))?))$/.exec(g.nodeValue)))if(l[1])if(l[2]){h.nextNode=g;h.onCreated(h);h=p}else{h.nextNode=g;h.onCreated(h);return g}else{n=n||c(g.parentNode,"view",true);if(l[2])h=new i(g,s++,b,h,n,k);else{j=a.view(g);if(j&&j.prevNode===g)if(j.data===m)u=j.nextNode;else{j.data=m;j.render();return j.nextNode}else j=new i(g,l[3],l[4],h,n,k,m);g=u||f(g,j,k,r,0)}}else q===0&&h.nodes.push(g);g=g.nextSibling}}function e(o,h,l,y,e){e=e||{};o=g(o);if(a.isFunction(h)){e.beforeChange=h;h=b}else h=g(h);var z,u,i,q,t,w=h,A=this,s=[],v=e.beforeChange,j=o[0],m=arguments.length-1;if(!v&&e&&a.isFunction(e))v=e.beforeChange=e;if(!j)return;t=j.nodeType;l=l?a.isArray(l)?l:[l]:[];m=l.length;if(y){if(t){o.each(function(){var a=c(this,"to");if(a.length){a=a[0];if(a===h[0])return;r(this,{target:a,options:e,links:[{from:"input["+d.linkToAttr+"]"}]})}n(this,{target:h[0],options:e,links:[{from:"input["+d.linkToAttr+"]"}]})});return}h.each(function(){f(this,a.view(this),e,b,b,j)});return}if(t){(m||e.beforeChange)&&o.each(function(){n(this,{target:h[0],options:e,links:l})});return}if(m){while(m--){u=l[m];q=u.to;if(q)w=h.find(q).add(a(this).filter(q));w.each(function(){i=a.extend({source:j,target:this,options:e},u);i.to=b;s.push(i)})}m=s.length;while(m--){i=s[m];var p=j,x=i.getFrom;innerPath=(x||i.from).split("."),innerLinks=[];while(innerPath.length>1){p=p[innerPath.shift()];p&&k(p,a.extend({inner:innerPath.join(".")},i))}k(j,i,x)}return}e.beforeChange&&k(j,{source:j,target:h,options:e})}function k(e,b,g){var f=b.target,d=function(){m.propertyChange.apply(b,arguments)};c(f,"from",true).push({source:e,handler:d,inner:b.inner});a(e).bind("propertyChange",d);g&&d({target:e})}function n(d,b){var f=b.target,e=function(){m.change.apply(b,arguments)};c(d,"to",true).push(f);a(d).bind("change",e)}function r(e,f){var b=c(e,"to"),d=b.length;while(d--)if(b[d]===f.target){a(e).unbind("change");b.splice(d,1)}}function j(b){var e,d=b.data,c=b._onArrayChange;if(c){if(c[1]===d)return;a([c[1]]).unbind("arrayChange",c[0])}if(a.isArray(d)){e=function(){m.arrayChange.apply({target:b,options:b.options},arguments)};a([d]).bind("arrayChange",e);b._onArrayChange=[e,d]}}function v(j,d){var h,f,b,g,e,i;c(d,"to").length&&a(d).unbind("change");f=c(d,"from"),b=f.length;while(b--){h=f[b];a(h.source).unbind("propertyChange",h.handler)}g=c(d,"view");if(b=g.length){e=a.view(d);while(b--){i=g[b];i.parent===e&&e.removeViews(i.index,1)}}}function c(c,e,d){var b=a.data(c,q)||d&&a.data(c,q,{view:[],from:[],to:[]});return b?b[e]:[]}function o(c,e,f){if(c){var g,h,b,i,a=0,d=c.replace(/(\s*\,\s*)|(\(\s*)|(\s*\))/g,function(b,d,c){return d?a?b:"\r":c?a++?b:"\t":--a?b:"\t"}).split("\r");b=d.length;while(b--)f.apply(e,d[b].split("\t"))}}function g(b){return b instanceof a?b:a.isArray(b)?a([b]):a(b)}function t(b,e){if(b&&e){var c,d=l(b,e);b=d&&d[0];if(b){c=b[d[1]];return a.isFunction(c)?c.call(b):c}}return b}function l(a,b){if(a&&b){var c=b.split(".");b=c.pop();while(a&&c.length)a=a[c.shift()]}return a&&a[b]&&[a,b]}function u(b){return b.type==="checkbox"?b.checked:a(b).val()}var s=a.cleanData;a.extend({cleanData:function(b){a(b).each(v);s(b)},link:function(h,c,f,d){d=d||{};if(a.isFunction(c)){d.beforeChange=c;c=b}else c=g(c);if(c&&c[0].nodeType)c.each(function(){e(h,this,f,false,d)});else g(h).each(function(){e(this,c,f,false,d)})},view:function(b,l){var d,g,e,j,k,f=document.body;b=b||f;if(!b.nodeType&&!l&&a.isPlainObject(b)){l=b;b=f}if(h&&!h.views.length)d=h;else{while(!(e=c(k=b.parentNode||f,"view")).length){if(!k||b===f){c(f.parentNode,"view",true).push(d=h=new i);break}b=k}if(!d&&b===f)d=e[0];while(!d&&b){if(b.nodeType===8)if(/^\/item|^\/tmpl$/.test(b.nodeValue)){j=e.length;while(j--){g=e[j];if(g.nextNode===b){b=g.prevNode;break}}}else if(/^item|^tmpl(\([\w\.]*\))?(\s+[^\s]+)?$/.test(b.nodeValue)){j=e.length;while(j--){g=e[j];if(g.prevNode===b){d=g;break}}}b=b.previousSibling}d=d||a.view(k)}return l?a.extend(d,l):d},linkSettings:{linkToAttr:"data-to",linkFromAttr:"data-from",getFromAttr:"data-getfrom",merge:{input:{from:{fromAttr:u},to:{toAttr:"value"}}},view:{onDataChanged:function(a){if(a){var b=this,e=a.change,c=a.index,f=a.oldIndex,d=a.items;switch(e){case"insert":b.addViews(c,d);break;case"remove":b.removeViews(c,d.length);break;case"move":b.render();break;case"refresh":b.render()}}return true},onCreated:function(a){if(this.parent)this.parent.onCreated(a)},render:function(){var h,g=a.render(this.tmpl,this.data),c=this.prevNode,e=this.nextNode,d=c.parentNode;a(this.nodes).remove();this.removeViews(0,this.views.length);this.nodes=[];a(c).after(g);d.removeChild(c.nextSibling);d.removeChild(e.previousSibling);f(d,this,b,e,0,b,c,0);j(this);return this},addViews:function(e,g,l){var i=g.length,j=this.views;if(i){var k=a.render(l||this.tmpl,g),c=e?j[e-1].nextNode:this.prevNode,h=c.nextSibling,d=c.parentNode;a(c).after(k);d.removeChild(c.nextSibling);d.removeChild(h.previousSibling);f(d,this,b,h,0,b,c,e)}return this},removeViews:function(e,l,m){if(l){var g,k,i=this.views,n=e+l;while(n-->e){var d=i[n],f=d.views.length,h=d.prevNode,p=d.nextNode,o=[h];f&&d.removeViews(0,f,m);g=g||c(d.nextNode.parentNode,"view");f=g.length;while(f--&&k===b)if(g[f]===d)k=f;g.splice(k,1);if(!m){while(h!==p){h=h.nextSibling;o.push(h)}a(o).remove()}d.data=b;j(d)}i.splice(e,l);viewCount=i.length;while(e<viewCount)a.observable(i[e]).setProperty("index",e++)}return this},each:function(a){a(this);var b=this.views.length;while(b--)this.views[b].each(a);return this},view:function(b){return a.extend(view,b)},content:function(b){return b?a(b,this.nodes):a(this.nodes)}}}});a.fn.extend({view:function(b){return a.view(this[0],b)},link:function(a,c){if(a){e(a,this,b,true,c);e(this,a,b,true,c)}return this},linkFrom:function(a,c,b){e(a,this,c,false,b);return this},linkTo:function(a,c,b){e(this,a,c,false,b);return this}});d=a.linkSettings;i.prototype=d.view;w=d.decl})(jQuery);